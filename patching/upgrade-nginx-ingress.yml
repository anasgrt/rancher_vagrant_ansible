---
- name: Upgrade nginx-ingress on downstream clusters
  hosts: key_control
  become: true
  vars_files:
    - ../group_vars/all.yml
    - patch-versions.yml

  tasks:
    - name: Get current nginx-ingress version
      ansible.builtin.shell: |
        {{ rke2_bin_path }}/kubectl --kubeconfig={{ rke2_kubeconfig }} \
        get helmchart nginx-ingress -n kube-system -o jsonpath='{.spec.version}' 2>/dev/null || echo "not-installed"
      register: current_nginx
      changed_when: false

    - name: Skip if not installed
      ansible.builtin.debug:
        msg: "nginx-ingress not installed, skipping upgrade"
      when: current_nginx.stdout == "not-installed"

    - name: Skip if already on target version
      ansible.builtin.debug:
        msg: "nginx-ingress already at {{ nginx_ingress_version }}, skipping upgrade"
      when: current_nginx.stdout == nginx_ingress_version

    - name: Upgrade nginx-ingress HelmChart
      ansible.builtin.shell: |
        {{ rke2_bin_path }}/kubectl --kubeconfig={{ rke2_kubeconfig }} \
        patch helmchart nginx-ingress -n kube-system --type='merge' \
        -p '{"spec":{"version":"{{ nginx_ingress_version }}"}}'
      when: current_nginx.stdout != nginx_ingress_version and current_nginx.stdout != "not-installed"
      register: nginx_upgraded

    - name: Wait for nginx-ingress pods to be ready
      ansible.builtin.shell: |
        {{ rke2_bin_path }}/kubectl --kubeconfig={{ rke2_kubeconfig }} \
        wait --for=condition=Ready pod -l app.kubernetes.io/name=ingress-nginx -n ingress-nginx --timeout=300s
      when: nginx_upgraded is changed
      changed_when: false
      failed_when: false

    - name: Display upgrade status
      ansible.builtin.debug:
        msg: "✅ nginx-ingress upgraded: {{ current_nginx.stdout }} → {{ nginx_ingress_version }}"
      when: nginx_upgraded is changed
