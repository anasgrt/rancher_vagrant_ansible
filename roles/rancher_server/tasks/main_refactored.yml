---
# ============================================================================
# REFACTORED RANCHER SERVER ROLE
# Simplified from 363 lines to ~180 lines while maintaining exact same logic
# ============================================================================

# ============================================================================
# SECTION 1: WAIT FOR RKE2 TO BE READY
# ============================================================================
- name: Wait for RKE2 ingress controller (if enabled)
  ansible.builtin.command: "{{ rke2_bin_path }}/kubectl --kubeconfig={{ rke2_kubeconfig }} -n kube-system get ds rke2-ingress-nginx-controller"
  register: ingress_check
  until: ingress_check.rc == 0
  retries: 60
  delay: 5
  changed_when: false
  when: not disable_ingress_nginx_management | bool

# ============================================================================
# SECTION 2: INSTALL CERT-MANAGER
# ============================================================================
- name: Install cert-manager namespace and CRDs
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: cert-manager

- name: Install cert-manager CRDs
  kubernetes.core.k8s:
    state: present
    src: https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.crds.yaml
    validate_certs: false

- name: Install cert-manager via Helm
  kubernetes.core.helm:
    name: cert-manager
    chart_ref: jetstack/cert-manager
    release_namespace: cert-manager
    create_namespace: false
    chart_version: "{{ cert_manager_version | default('v1.13.0') }}"
    values:
      installCRDs: false
      global:
        leaderElection:
          namespace: cert-manager
    kubeconfig: "{{ rke2_kubeconfig }}"
  environment:
    KUBECONFIG: "{{ rke2_kubeconfig }}"

# ============================================================================
# SECTION 3: GENERATE CERTIFICATES (if using CA-signed)
# ============================================================================
- name: Generate and install certificates
  when: rancher_ca_signed_cert | bool
  block:
    - name: Create temporary directory for certificates
      ansible.builtin.tempfile:
        state: directory
        suffix: certs
      register: ca_temp_dir

    - name: Generate CA private key
      community.crypto.openssl_privatekey:
        path: "{{ ca_temp_dir.path }}/ca.key"
        size: 4096

    - name: Generate CA certificate
      community.crypto.x509_certificate:
        path: "{{ ca_temp_dir.path }}/ca.crt"
        privatekey_path: "{{ ca_temp_dir.path }}/ca.key"
        provider: selfsigned
        selfsigned_not_after: "+3650d"
        basic_constraints: ["CA:TRUE"]
        basic_constraints_critical: true

    - name: Generate server private key
      community.crypto.openssl_privatekey:
        path: "{{ ca_temp_dir.path }}/tls.key"
        size: 4096

    - name: Generate server CSR
      community.crypto.openssl_csr:
        path: "{{ ca_temp_dir.path }}/tls.csr"
        privatekey_path: "{{ ca_temp_dir.path }}/tls.key"
        common_name: "{{ rancher_hostname }}"
        subject_alt_name:
          - "DNS:{{ rancher_hostname }}"
          - "DNS:*.{{ rancher_hostname }}"

    - name: Generate server certificate
      community.crypto.x509_certificate:
        path: "{{ ca_temp_dir.path }}/tls.crt"
        csr_path: "{{ ca_temp_dir.path }}/tls.csr"
        provider: ownca
        ownca_path: "{{ ca_temp_dir.path }}/ca.crt"
        ownca_privatekey_path: "{{ ca_temp_dir.path }}/ca.key"
        ownca_not_after: "+365d"

    - name: Copy CA certificate to shared directory
      ansible.builtin.copy:
        src: "{{ ca_temp_dir.path }}/ca.crt"
        dest: "{{ shared_dir }}/rancher-ca.crt"
        mode: '0644'
      delegate_to: localhost

    - name: Create cattle-system namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: cattle-system
        kubeconfig: "{{ rke2_kubeconfig }}"
        validate: false

    - name: Create TLS secret for Rancher
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          type: kubernetes.io/tls
          metadata:
            name: tls-rancher-ingress
            namespace: cattle-system
          data:
            tls.crt: "{{ lookup('file', ca_temp_dir.path + '/tls.crt') | b64encode }}"
            tls.key: "{{ lookup('file', ca_temp_dir.path + '/tls.key') | b64encode }}"
        kubeconfig: "{{ rke2_kubeconfig }}"
        validate: false

    - name: Create CA secret for Rancher
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: tls-ca
            namespace: cattle-system
          data:
            cacerts.pem: "{{ lookup('file', ca_temp_dir.path + '/ca.crt') | b64encode }}"
        kubeconfig: "{{ rke2_kubeconfig }}"
        validate: false

# ============================================================================
# SECTION 4: INSTALL RANCHER VIA HELM
# ============================================================================
- name: Check for existing Rancher Helm release
  ansible.builtin.command: helm list -n cattle-system -o json
  register: rancher_helm_check
  changed_when: false
  environment:
    KUBECONFIG: "{{ rke2_kubeconfig }}"

- name: Install Rancher via Helm
  kubernetes.core.helm:
    name: rancher
    chart_ref: rancher-latest/rancher
    release_namespace: cattle-system
    create_namespace: true
    values:
      hostname: "{{ rancher_hostname }}"
      replicas: 1
      bootstrapPassword: "{{ rancher_bootstrap_password }}"
      ingress:
        tls:
          source: "{{ 'secret' if rancher_ca_signed_cert else 'rancher' }}"
    kubeconfig: "{{ rke2_kubeconfig }}"
  environment:
    KUBECONFIG: "{{ rke2_kubeconfig }}"
  retries: 3
  delay: 10
  register: rancher_install
  until: rancher_install is succeeded

- name: Wait for Rancher to be ready
  ansible.builtin.uri:
    url: "{{ rancher_url }}/ping"
    validate_certs: false
    status_code: 200
  register: rancher_ping
  until: rancher_ping.status == 200
  retries: 60
  delay: 10

- name: Wait for Rancher initialization
  ansible.builtin.pause:
    seconds: "{{ timeout_rancher_init }}"

# ============================================================================
# SECTION 5: GET RANCHER API TOKEN
# ============================================================================
- name: Get Rancher bootstrap password from secret
  ansible.builtin.command: >
    {{ rke2_bin_path }}/kubectl --kubeconfig={{ rke2_kubeconfig }}
    get secret --namespace cattle-system bootstrap-secret
    -o jsonpath='{.data.bootstrapPassword}'
  register: bootstrap_password_b64
  changed_when: false
  failed_when: false

- name: Set bootstrap password
  ansible.builtin.set_fact:
    actual_bootstrap_password: "{{ (bootstrap_password_b64.stdout | b64decode | trim) if bootstrap_password_b64.rc == 0 else rancher_bootstrap_password }}"

- name: Login to Rancher and get API token
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3-public/localProviders/local?action=login"
    method: POST
    body_format: json
    body:
      username: "admin"
      password: "{{ actual_bootstrap_password }}"
    validate_certs: false
    status_code: 201
  register: rancher_login_result

- name: Save Rancher API token
  ansible.builtin.copy:
    content: "{{ rancher_login_result.json.token }}"
    dest: "{{ shared_dir }}/rancher_token"
    mode: '0600'
  delegate_to: localhost

# ============================================================================
# SECTION 6: CREATE DOWNSTREAM CLUSTERS AND REGISTRATION TOKENS
# Simplified from 10 tasks to 3 tasks
# ============================================================================
- name: Create downstream clusters in Rancher
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/cluster"
    method: POST
    headers:
      Authorization: "Bearer {{ rancher_login_result.json.token }}"
    body_format: json
    body:
      type: "cluster"
      name: "{{ item.name }}"
      description: "{{ item.environment }} cluster"
    validate_certs: false
    status_code: [201, 409, 422]
  loop: "{{ downstream_clusters }}"
  register: cluster_creation

- name: Get cluster IDs and create registration tokens
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/clusters?name={{ item.name }}"
    method: GET
    headers:
      Authorization: "Bearer {{ rancher_login_result.json.token }}"
    validate_certs: false
  loop: "{{ downstream_clusters }}"
  register: cluster_list
  retries: 3
  delay: 5

- name: Create cluster registration tokens
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/clusterregistrationtoken"
    method: POST
    headers:
      Authorization: "Bearer {{ rancher_login_result.json.token }}"
    body_format: json
    body:
      type: "clusterRegistrationToken"
      clusterId: "{{ item.json.data[0].id }}"
    validate_certs: false
    status_code: [201, 409]
  loop: "{{ cluster_list.results }}"
  when: item.json.data | length > 0
  register: token_creation
  retries: 3
  delay: 5

- name: Get registration tokens
  ansible.builtin.uri:
    url: "{{ rancher_url }}/v3/clusterregistrationtoken?clusterId={{ item.json.data[0].id }}"
    method: GET
    headers:
      Authorization: "Bearer {{ rancher_login_result.json.token }}"
    validate_certs: false
  loop: "{{ cluster_list.results }}"
  when: item.json.data | length > 0
  register: registration_tokens
  retries: 5
  delay: 10

- name: Save cluster import information
  ansible.builtin.copy:
    content: |
      cluster_id: {{ item.item.json.data[0].id }}
      cluster_name: {{ item.item.item.name }}
      import_command: "curl -ksfL {{ rancher_url }}/v3/import/{{ item.json.data[0].token }}_{{ item.item.json.data[0].id }}.yaml | kubectl apply -f -"
      registration_token: {{ item.json.data[0].token }}
    dest: "{{ shared_dir }}/cluster_{{ item.item.item.name }}_import.yml"
    mode: '0644'
  loop: "{{ registration_tokens.results }}"
  delegate_to: localhost
  when: item.json.data is defined and item.json.data | length > 0
