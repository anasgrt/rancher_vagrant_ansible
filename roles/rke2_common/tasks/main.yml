---
# Common RKE2 installation tasks used by server, control, and worker nodes
# This role should be included BEFORE starting the RKE2 service
- name: Download RKE2 installation script
  ansible.builtin.get_url:
    url: "{{ rke2_install_url }}"
    dest: /tmp/rke2_install.sh
    mode: '0755'

- name: Install RKE2
  ansible.builtin.shell: |
    {% if rke2_version != 'latest' %}
    INSTALL_RKE2_TYPE='{{ rke2_type }}' INSTALL_RKE2_VERSION='{{ rke2_version }}' /tmp/rke2_install.sh
    {% else %}
    INSTALL_RKE2_TYPE='{{ rke2_type }}' INSTALL_RKE2_CHANNEL='{{ rke2_channel }}' /tmp/rke2_install.sh
    {% endif %}
  args:
    creates: /usr/local/bin/rke2

- name: Create RKE2 config directory
  ansible.builtin.file:
    path: "{{ rke2_config_dir }}"
    state: directory
    mode: '0755'
