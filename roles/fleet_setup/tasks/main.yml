---
- name: Wait for Rancher token
  wait_for:
    path: "{{ shared_dir }}/rancher_token"
    timeout: 300
  delegate_to: localhost
  become: false

- name: Read Rancher token
  slurp:
    src: "{{ shared_dir }}/rancher_token"
  register: rancher_token_content
  delegate_to: localhost
  become: false

- name: Set Rancher token fact
  set_fact:
    rancher_token: "{{ rancher_token_content.content | b64decode | trim }}"

- name: Wait for downstream clusters to be registered in Rancher
  uri:
    url: "{{ rancher_url }}/v3/clusters?name={{ item.name }}"
    method: GET
    headers:
      Authorization: "Bearer {{ rancher_token }}"
    validate_certs: false
    status_code: [200, 503]
  register: cluster_status
  until: >
    cluster_status.status == 200 and
    cluster_status.json is defined and
    cluster_status.json.data is defined and
    cluster_status.json.data | length > 0 and
    cluster_status.json.data[0].state in ["active", "provisioning", "updating", "pending"]
  retries: 120
  delay: 10
  loop: "{{ downstream_clusters }}"
  ignore_errors: true

- name: Wait for Fleet controller
  shell: "{{ rke2_bin_path }}/kubectl --kubeconfig={{ rke2_kubeconfig }} -n cattle-fleet-system rollout status deployment/fleet-controller --timeout=300s"
  ignore_errors: true

- name: Label downstream clusters for Fleet targeting
  uri:
    url: "{{ rancher_url }}/v3/clusters/{{ item.json.data[0].id }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ rancher_token }}"
    body_format: json
    body: |
      {%- set cluster = item.json.data[0] -%}
      {%- set _ = cluster.labels.update({'env': item.item.environment, 'cluster': item.item.name}) -%}
      {{ cluster | to_json }}
    validate_certs: false
    status_code: [200, 201]
  loop: "{{ cluster_status.results }}"
  when: item.json.data is defined and item.json.data | length > 0
  ignore_errors: true

- name: Label local cluster for Fleet
  uri:
    url: "{{ rancher_url }}/v3/clusters?name=local"
    method: GET
    headers:
      Authorization: "Bearer {{ rancher_token }}"
    validate_certs: false
    status_code: [200, 503]
  register: local_cluster
  until: local_cluster.status == 200
  retries: 30
  delay: 10

- name: Apply local cluster labels
  uri:
    url: "{{ rancher_url }}/v3/clusters/{{ local_cluster.json.data[0].id }}"
    method: PUT
    headers:
      Authorization: "Bearer {{ rancher_token }}"
    body_format: json
    body: |
      {%- set cluster = local_cluster.json.data[0] -%}
      {%- set _ = cluster.labels.update({'env': fleet_local_environment, 'cluster': 'local'}) -%}
      {{ cluster | to_json }}
    validate_certs: false
    status_code: [200, 201]
  when: local_cluster.json.data is defined and local_cluster.json.data | length > 0
  ignore_errors: true

- name: Create Fleet GitRepo for key clusters
  shell: |
    {{ rke2_bin_path }}/kubectl --kubeconfig={{ rke2_kubeconfig }} apply -f - <<EOF
    apiVersion: fleet.cattle.io/v1alpha1
    kind: GitRepo
    metadata:
      name: {{ fleet_key_git_repo_name }}
      namespace: {{ fleet_workspace_name }}
    spec:
      repo: {{ fleet_key_git_repo_url }}
      branch: {{ fleet_key_git_branch }}
      paths:
    {% for path in fleet_key_git_paths %}
        - {{ path }}
    {% endfor %}
      pollingInterval: {{ fleet_key_polling_interval }}
      targets:
      - clusterSelector:
          matchLabels:
            env: {{ fleet_key_environment }}
    EOF
  when: fleet_key_enabled | bool
  ignore_errors: true

- name: Create Fleet GitRepo for local cluster
  shell: |
    {{ rke2_bin_path }}/kubectl --kubeconfig={{ rke2_kubeconfig }} apply -f - <<EOF
    apiVersion: fleet.cattle.io/v1alpha1
    kind: GitRepo
    metadata:
      name: {{ fleet_local_git_repo_name }}
      namespace: {{ fleet_workspace_name }}
    spec:
      repo: {{ fleet_local_git_repo_url }}
      branch: {{ fleet_local_git_branch }}
      paths:
    {% for path in fleet_local_git_paths %}
        - {{ path }}
    {% endfor %}
      pollingInterval: {{ fleet_local_polling_interval }}
      targets:
      - clusterSelector:
          matchLabels:
            env: {{ fleet_local_environment }}
    EOF
  when: fleet_local_enabled | bool
  ignore_errors: true

- name: Display Fleet setup completion
  debug:
    msg:
      - "Fleet GitOps configured successfully"
      - "Key clusters GitRepo: {{ fleet_key_git_repo_name }}"
      - "Local cluster GitRepo: {{ fleet_local_git_repo_name }}"
