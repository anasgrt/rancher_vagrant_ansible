---
- name: Deploy local-path storage provisioner
  shell: |
    /var/lib/rancher/rke2/bin/kubectl --kubeconfig={{ rke2_kubeconfig }} apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.30/deploy/local-path-storage.yaml
  args:
    executable: /bin/bash

- name: Wait for local-path provisioner to be ready
  shell: |
    /var/lib/rancher/rke2/bin/kubectl --kubeconfig={{ rke2_kubeconfig }} wait --for=condition=available --timeout=300s deployment/local-path-provisioner -n local-path-storage
  args:
    executable: /bin/bash
  retries: 3
  delay: 10

- name: Set local-path as default storage class
  shell: |
    /var/lib/rancher/rke2/bin/kubectl --kubeconfig={{ rke2_kubeconfig }} patch storageclass local-path -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
  args:
    executable: /bin/bash
